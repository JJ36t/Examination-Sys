{% extends "admin_layout.html" %}

{% block admin_content %}
<div class="card shadow mb-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">تصدير واستيراد البيانات</h5>
    </div>
    <div class="card-body">
        <ul class="nav nav-tabs" id="dataTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="export-tab" data-bs-toggle="tab" data-bs-target="#export-tab-pane" type="button" role="tab">تصدير البيانات</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="import-tab" data-bs-toggle="tab" data-bs-target="#import-tab-pane" type="button" role="tab">استيراد البيانات</button>
            </li>
        </ul>
        
        <div class="tab-content p-3" id="dataTabContent">
            <!-- تصدير البيانات -->
            <div class="tab-pane fade show active" id="export-tab-pane" role="tabpanel" aria-labelledby="export-tab" tabindex="0">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">تصدير بيانات الطلاب</h6>
                            </div>
                            <div class="card-body">
                                <form id="exportStudentsForm">
                                    <div class="mb-3">
                                        <label class="form-label">نوع البيانات</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="student_data_type" id="allStudentsData" value="all" checked>
                                            <label class="form-check-label" for="allStudentsData">
                                                جميع بيانات الطلاب
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="student_data_type" id="stageStudentsData" value="stage">
                                            <label class="form-check-label" for="stageStudentsData">
                                                الطلاب حسب المرحلة
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="student_data_type" id="departmentStudentsData" value="department">
                                            <label class="form-check-label" for="departmentStudentsData">
                                                الطلاب حسب القسم
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3" id="stageSelectDiv" style="display: none;">
                                        <label for="stageSelect" class="form-label">المرحلة</label>
                                        <select class="form-select" id="stageSelect" name="stage">
                                            <option value="1">المرحلة الأولى</option>
                                            <option value="2">المرحلة الثانية</option>
                                            <option value="3">المرحلة الثالثة</option>
                                            <option value="4">المرحلة الرابعة</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3" id="departmentSelectDiv" style="display: none;">
                                        <label for="departmentSelect" class="form-label">القسم</label>
                                        <select class="form-select" id="departmentSelect" name="department">
                                            <option value="علوم الحاسوب">علوم الحاسوب</option>
                                            <option value="نظم المعلومات">نظم المعلومات</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">تنسيق التصدير</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="student_export_format" id="csvStudentFormat" value="csv" checked>
                                            <label class="form-check-label" for="csvStudentFormat">
                                                CSV
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="student_export_format" id="excelStudentFormat" value="excel">
                                            <label class="form-check-label" for="excelStudentFormat">
                                                Excel
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="student_export_format" id="pdfStudentFormat" value="pdf">
                                            <label class="form-check-label" for="pdfStudentFormat">
                                                PDF
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <button type="button" class="btn btn-primary" id="exportStudentsBtn">
                                        <i class="fas fa-download"></i> تصدير بيانات الطلاب
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">تصدير بيانات الدرجات</h6>
                            </div>
                            <div class="card-body">
                                <form id="exportGradesForm">
                                    <div class="mb-3">
                                        <label class="form-label">نوع البيانات</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="grade_data_type" id="allGradesData" value="all" checked>
                                            <label class="form-check-label" for="allGradesData">
                                                جميع الدرجات
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="grade_data_type" id="courseGradesData" value="course">
                                            <label class="form-check-label" for="courseGradesData">
                                                الدرجات حسب المقرر
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="grade_data_type" id="stageGradesData" value="stage">
                                            <label class="form-check-label" for="stageGradesData">
                                                الدرجات حسب المرحلة
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3" id="gradeStageSelectDiv" style="display: none;">
                                        <label for="gradeStageSelect" class="form-label">المرحلة</label>
                                        <select class="form-select" id="gradeStageSelect" name="stage">
                                            <option value="1">المرحلة الأولى</option>
                                            <option value="2">المرحلة الثانية</option>
                                            <option value="3">المرحلة الثالثة</option>
                                            <option value="4">المرحلة الرابعة</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3" id="courseSelectDiv" style="display: none;">
                                        <label for="courseSelect" class="form-label">المقرر</label>
                                        <select class="form-select" id="courseSelect" name="course_id">
                                            <!-- سيتم ملؤها عبر JavaScript -->
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">تنسيق التصدير</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="grade_export_format" id="csvGradeFormat" value="csv" checked>
                                            <label class="form-check-label" for="csvGradeFormat">
                                                CSV
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="grade_export_format" id="excelGradeFormat" value="excel">
                                            <label class="form-check-label" for="excelGradeFormat">
                                                Excel
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="grade_export_format" id="pdfGradeFormat" value="pdf">
                                            <label class="form-check-label" for="pdfGradeFormat">
                                                PDF
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <button type="button" class="btn btn-primary" id="exportGradesBtn">
                                        <i class="fas fa-download"></i> تصدير بيانات الدرجات
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">تصدير بيانات المقررات</h6>
                            </div>
                            <div class="card-body">
                                <form id="exportCoursesForm" class="row">
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            <label class="form-label">تنسيق التصدير</label>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="course_export_format" id="csvCourseFormat" value="csv" checked>
                                                <label class="form-check-label" for="csvCourseFormat">
                                                    CSV
                                                </label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="course_export_format" id="excelCourseFormat" value="excel">
                                                <label class="form-check-label" for="excelCourseFormat">
                                                    Excel
                                                </label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="course_export_format" id="pdfCourseFormat" value="pdf">
                                                <label class="form-check-label" for="pdfCourseFormat">
                                                    PDF
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 d-flex align-items-end">
                                        <button type="button" class="btn btn-primary" id="exportCoursesBtn">
                                            <i class="fas fa-download"></i> تصدير بيانات المقررات
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- استيراد البيانات -->
            <div class="tab-pane fade" id="import-tab-pane" role="tabpanel" aria-labelledby="import-tab" tabindex="0">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">استيراد بيانات الطلاب</h6>
                            </div>
                            <div class="card-body">
                                <form id="importStudentsForm">
                                    <div class="mb-3">
                                        <label for="studentsFile" class="form-label">ملف بيانات الطلاب (CSV أو Excel)</label>
                                        <input class="form-control" type="file" id="studentsFile" name="students_file" accept=".csv,.xlsx,.xls">
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="createStudentAccounts" name="create_accounts" checked>
                                            <label class="form-check-label" for="createStudentAccounts">
                                                إنشاء حسابات للطلاب تلقائيًا
                                            </label>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="defaultDepartment" class="form-label">القسم الافتراضي</label>
                                        <select class="form-select" id="defaultDepartment" name="default_department">
                                            <option value="علوم الحاسوب">علوم الحاسوب</option>
                                            <option value="نظم المعلومات">نظم المعلومات</option>
                                        </select>
                                        <div class="form-text">سيتم تعيين هذا القسم للطلاب إذا لم يتم تحديد القسم في ملف الاستيراد</div>
                                    </div>
                                    <button type="button" class="btn btn-success" id="importStudentsBtn">
                                        <i class="fas fa-upload"></i> استيراد بيانات الطلاب
                                    </button>
                                </form>
                                
                                <div class="mt-3">
                                    <p class="text-muted small">
                                        <i class="fas fa-info-circle"></i>
                                        يجب أن يحتوي ملف الطلاب على الحقول التالية: اسم الطالب، رقم الطالب، المرحلة
                                    </p>
                                    <p class="mt-2">
                                        <a href="/static/templates/student_template.xlsx" class="text-primary">
                                            <i class="fas fa-download"></i> تحميل قالب ملف بيانات الطلاب
                                        </a>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">استيراد بيانات المقررات</h6>
                            </div>
                            <div class="card-body">
                                <form id="importCoursesForm">
                                    <div class="mb-3">
                                        <label for="coursesFile" class="form-label">ملف بيانات المقررات (CSV أو Excel)</label>
                                        <input class="form-control" type="file" id="coursesFile" name="courses_file" accept=".csv,.xlsx,.xls">
                                    </div>
                                    <button type="button" class="btn btn-success" id="importCoursesBtn">
                                        <i class="fas fa-upload"></i> استيراد بيانات المقررات
                                    </button>
                                </form>
                                
                                <div class="mt-3">
                                    <p class="text-muted small">
                                        <i class="fas fa-info-circle"></i>
                                        يجب أن يحتوي ملف المقررات على الحقول التالية: اسم المقرر، المرحلة، الفصل، عدد الوحدات
                                    </p>
                                    <p class="mt-2">
                                        <a href="/static/templates/course_template.xlsx" class="text-primary">
                                            <i class="fas fa-download"></i> تحميل قالب ملف بيانات المقررات
                                        </a>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">استيراد بيانات الدرجات</h6>
                            </div>
                            <div class="card-body">
                                <form id="importGradesForm">
                                    <div class="mb-3">
                                        <label for="gradesFile" class="form-label">ملف بيانات الدرجات (CSV أو Excel)</label>
                                        <input class="form-control" type="file" id="gradesFile" name="grades_file" accept=".csv,.xlsx,.xls">
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="overwriteExistingGrades" name="overwrite_existing" checked>
                                            <label class="form-check-label" for="overwriteExistingGrades">
                                                استبدال الدرجات الموجودة
                                            </label>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-success" id="importGradesBtn">
                                        <i class="fas fa-upload"></i> استيراد بيانات الدرجات
                                    </button>
                                </form>
                                
                                <div class="mt-3">
                                    <p class="text-muted small">
                                        <i class="fas fa-info-circle"></i>
                                        يجب أن يحتوي ملف الدرجات على الحقول التالية: رقم الطالب، اسم المقرر، درجة الأعمال، درجة الامتحان النهائي
                                    </p>
                                    <p class="mt-2">
                                        <a href="/static/templates/grade_template.xlsx" class="text-primary">
                                            <i class="fas fa-download"></i> تحميل قالب ملف بيانات الدرجات
                                        </a>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // استيراد وتصدير الطلاب
    document.getElementById('exportStudentsBtn').addEventListener('click', exportStudents);
    document.getElementById('importStudentsBtn').addEventListener('click', importStudents);
    
    // استيراد وتصدير الدرجات
    document.getElementById('exportGradesBtn').addEventListener('click', exportGrades);
    document.getElementById('importGradesBtn').addEventListener('click', importGrades);
    
    // استيراد وتصدير المقررات
    document.getElementById('exportCoursesBtn').addEventListener('click', exportCourses);
    document.getElementById('importCoursesBtn').addEventListener('click', importCourses);
    
    // إظهار/إخفاء حقول إضافية حسب نوع البيانات
    document.querySelectorAll('input[name="student_data_type"]').forEach(radio => {
        radio.addEventListener('change', function() {
            document.getElementById('stageSelectDiv').style.display = 
                this.value === 'stage' ? 'block' : 'none';
            document.getElementById('departmentSelectDiv').style.display = 
                this.value === 'department' ? 'block' : 'none';
        });
    });
    
    document.querySelectorAll('input[name="grade_data_type"]').forEach(radio => {
        radio.addEventListener('change', function() {
            document.getElementById('gradeStageSelectDiv').style.display = 
                this.value === 'stage' ? 'block' : 'none';
            document.getElementById('courseSelectDiv').style.display = 
                this.value === 'course' ? 'block' : 'none';
            
            if (this.value === 'course') {
                loadCourses();
            }
        });
    });
    
    // تحميل المقررات عند اختيار تصدير الدرجات حسب المقرر
    function loadCourses() {
        fetch('/get_courses')
            .then(response => response.json())
            .then(courses => {
                const courseSelect = document.getElementById('courseSelect');
                courseSelect.innerHTML = '';
                
                courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.id;
                    option.textContent = `${course.name} (المرحلة ${course.stage} - الفصل ${course.semester})`;
                    courseSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading courses:', error);
                alert('حدث خطأ أثناء تحميل المقررات.');
            });
    }
});

// وظائف تصدير البيانات
function exportStudents() {
    const form = document.getElementById('exportStudentsForm');
    const formData = new FormData(form);
    
    // تحديد معلمات التصدير
    const dataType = formData.get('student_data_type');
    const format = formData.get('student_export_format');
    const stage = formData.get('stage');
    const department = formData.get('department');
    
    // بناء رابط التصدير
    let url = `/admin/export/students?format=${format}`;
    if (dataType === 'stage' && stage) {
        url += `&stage=${stage}`;
    } else if (dataType === 'department' && department) {
        url += `&department=${department}`;
    }
    
    // فتح الرابط في نافذة جديدة للتنزيل
    window.open(url, '_blank');
}

function exportGrades() {
    const form = document.getElementById('exportGradesForm');
    const formData = new FormData(form);
    
    // تحديد معلمات التصدير
    const dataType = formData.get('grade_data_type');
    const format = formData.get('grade_export_format');
    const stage = formData.get('stage');
    const courseId = formData.get('course_id');
    
    // بناء رابط التصدير
    let url = `/admin/export/grades?format=${format}`;
    if (dataType === 'stage' && stage) {
        url += `&stage=${stage}`;
    } else if (dataType === 'course' && courseId) {
        url += `&course_id=${courseId}`;
    }
    
    // فتح الرابط في نافذة جديدة للتنزيل
    window.open(url, '_blank');
}

function exportCourses() {
    const form = document.getElementById('exportCoursesForm');
    const formData = new FormData(form);
    
    // تحديد تنسيق التصدير
    const format = formData.get('course_export_format');
    
    // بناء رابط التصدير
    const url = `/admin/export/courses?format=${format}`;
    
    // فتح الرابط في نافذة جديدة للتنزيل
    window.open(url, '_blank');
}

// وظائف استيراد البيانات
function importStudents() {
    const form = document.getElementById('importStudentsForm');
    const fileInput = document.getElementById('studentsFile');
    
    if (!fileInput.files || fileInput.files.length === 0) {
        alert('يرجى اختيار ملف أولاً');
        return;
    }
    
    const formData = new FormData(form);
    
    fetch('/admin/import/students', {
        method: 'POST',
        body: formData
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`تم استيراد ${data.imported_count} طالب بنجاح.`);
                form.reset();
            } else {
                alert(`حدث خطأ: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Error importing students:', error);
            alert('حدث خطأ أثناء استيراد بيانات الطلاب.');
        });
}

function importCourses() {
    const form = document.getElementById('importCoursesForm');
    const fileInput = document.getElementById('coursesFile');
    
    if (!fileInput.files || fileInput.files.length === 0) {
        alert('يرجى اختيار ملف أولاً');
        return;
    }
    
    const formData = new FormData(form);
    
    fetch('/admin/import/courses', {
        method: 'POST',
        body: formData
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`تم استيراد ${data.imported_count} مقرر بنجاح.`);
                form.reset();
            } else {
                alert(`حدث خطأ: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Error importing courses:', error);
            alert('حدث خطأ أثناء استيراد بيانات المقررات.');
        });
}

function importGrades() {
    const form = document.getElementById('importGradesForm');
    const fileInput = document.getElementById('gradesFile');
    
    if (!fileInput.files || fileInput.files.length === 0) {
        alert('يرجى اختيار ملف أولاً');
        return;
    }
    
    const formData = new FormData(form);
    
    fetch('/admin/import/grades', {
        method: 'POST',
        body: formData
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`تم استيراد ${data.imported_count} درجة بنجاح.`);
                form.reset();
            } else {
                alert(`حدث خطأ: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Error importing grades:', error);
            alert('حدث خطأ أثناء استيراد بيانات الدرجات.');
        });
}
</script>
{% endblock %}
